<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MyBusTimes Duty Generator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    font-family: Arial, Helvetica, sans-serif;
    background: #e6e6e6;
    margin: 0;
}

header {
    background: #000;
    color: #fff;
    padding: 12px;
    text-align: center;
    font-size: 20px;
}

.panel, .duty {
    background: #fff;
    max-width: 420px;
    margin: 15px auto;
    padding: 12px;
    border-radius: 6px;
}

input {
    width: 100%;
    padding: 8px;
    margin-bottom: 6px;
    font-size: 14px;
}

button {
    width: 100%;
    padding: 10px;
    margin-top: 6px;
    background: #000;
    color: #fff;
    border: none;
    cursor: pointer;
}

.add { background:#444; }
.warn { color:red; font-weight:bold; }

.trip-row {
    display: grid;
    grid-template-columns: 55px auto auto 50px 25px;
    gap: 5px;
    padding: 6px 0;
    font-size: 13px;
    cursor: grab;
    align-items: center;
}

.trip-row span { font-weight:bold; }

.trip-row button {
    background:none;
    color:red;
    padding:0;
    margin:0;
}

.trip-row input {
    font-size:13px;
    padding:2px;
    width:100%;
}

.duty-header {
    border-bottom:1px solid #ccc;
    padding-bottom:6px;
}

.route { font-size:28px; font-weight:bold; }
.depot { font-size:13px; color:#555; }

.trip {
    display:grid;
    grid-template-columns:55px auto;
    padding:6px 0;
    border-bottom:1px solid #eee;
}

.footer {
    font-size:12px;
    background:#f5f5f5;
    padding:6px;
}

@media print {
    body { background:white; }
    header, .panel { display:none; }
    .duty { border:none; }
}
</style>
</head>

<body>

<header>MyBusTimes Duty Generator</header>

<div class="panel">
    <input id="route" placeholder="Route (e.g. X1)">
    <input id="depot" placeholder="Depot (e.g. Wick)">

    <hr>

    <input id="time" placeholder="Time (HH:MM)">
    <input id="from" placeholder="From">
    <input id="to" placeholder="To">

    <button class="add" onclick="addTrip()">Add trip</button>

    <div id="editor"></div>

    <button onclick="generateDuty()">Generate duty</button>
    <button onclick="saveDuty()">Save duty</button>
    <button onclick="loadDuty()">Load duty</button>
</div>

<div id="output"></div>

<script>
let trips = [];
let dragIndex = null;

// Convert HH:MM to minutes
function toMin(t){
    const [h,m]=t.split(":").map(Number);
    return h*60+m;
}

function addTrip(){
    const time = document.getElementById("time").value.trim();
    const from = document.getElementById("from").value.trim();
    const to = document.getElementById("to").value.trim();
    if(!time || !from || !to) return alert("Fill all trip fields");

    trips.push({time, from, to});
    document.getElementById("time").value = "";
    document.getElementById("from").value = "";
    document.getElementById("to").value = "";
    renderEditor();
}

// Render editor with inline edit/delete & drag
function renderEditor(){
    const editor = document.getElementById("editor");
    editor.innerHTML = "";
    trips.forEach((t,i)=>{
        const d = document.createElement("div");
        d.className="trip-row";
        d.draggable=true;
        d.ondragstart=()=>dragIndex=i;
        d.ondragover=e=>e.preventDefault();
        d.ondrop=()=>swap(i);
        d.innerHTML=`
            <span>${t.time}</span>
            <input value="${t.from}" onchange="trips[${i}].from=this.value">
            <input value="${t.to}" onchange="trips[${i}].to=this.value">
            <button onclick="del(${i})">✖</button>
        `;
        editor.appendChild(d);
    });
}

function swap(i){
    [trips[dragIndex], trips[i]] = [trips[i], trips[dragIndex]];
    renderEditor();
}

function del(i){
    trips.splice(i,1);
    renderEditor();
}

// Generate MyBusTimes-style duty card
function generateDuty(){
    const routeEl = document.getElementById("route");
    const depotEl = document.getElementById("depot");
    if(!routeEl.value || !depotEl.value || !trips.length)
        return alert("Complete the duty first");

    trips.sort((a,b)=>toMin(a.time)-toMin(b.time));

    let total=0;
    for(let i=1;i<trips.length;i++)
        total += toMin(trips[i].time) - toMin(trips[i-1].time);

    let breakWarn = total > 270;
    let finish = trips[trips.length-1].to;
    let badFinish = finish !== depotEl.value;

    let html = `<div class="duty">
        <div class="duty-header">
            <div class="route">${routeEl.value}</div>
            <div class="depot">${depotEl.value} Depot</div>
        </div>`;

    trips.forEach(t=>{
        html += `
        <div class="trip">
            <div><strong>${t.time}</strong></div>
            <div>${t.from} → ${t.to}</div>
        </div>`;
    });

    html += `
        <div class="footer">
            Total duty: ${total} mins<br>
            ${breakWarn?'<span class="warn">Break required</span><br>':``}
            Finish: ${finish}${badFinish?' ⚠':''}
        </div>
    </div>`;

    document.getElementById("output").innerHTML = html;
}

// Save/load using localStorage
function saveDuty(){
    const routeEl = document.getElementById("route");
    const depotEl = document.getElementById("depot");
    localStorage.setItem("duty",
        JSON.stringify({route:routeEl.value,depot:depotEl.value,trips}));
    alert("Duty saved");
}

function loadDuty(){
    const d = JSON.parse(localStorage.getItem("duty"));
    if(!d) return;
    document.getElementById("route").value=d.route;
    document.getElementById("depot").value=d.depot;
    trips=d.trips;
    renderEditor();
}
</script>

</body>
</html>
